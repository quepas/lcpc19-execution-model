# Detection of instruction blocks

Performance events can be used to detect when the instruction blocks start.
However, not every event is suitable for detection.
While some events might never occur for our code (e.g. `SW_PREFETCH_ACCESS:PREFETCHW`), other events depict the execution of code, and only a few events show the preparation of instruction blocks (fetching and decoding).
Good candidates include events related to the activity of:
* Instruction cache (e.g. `L2_RQSTS:CODE_RD_MISS`)
* Translation-lookahead buffer for instructions [iTLB] (e.g. `ITLB_MISSES:MISS_CAUSES_A_WALK`)
* Front-end and instruction decoding ( e.g. `FRONTEND_RETIRED:L1I_MISS`)

To find out and validate which performance events can detect instruction blocks, we test performance events available on Skylake/Coffee Lake microarchitectures.
We start with the Intel document [skylake_core_v46.tsv](https://download.01.org/perfmon/SKL/skylake_core_v46.tsv) from which we select performance events available on both microarchitectures and correct/update their names to match the real-world processors.
Then, we run this simple expression `sqrt(A(1:LEN_1D)) + B .* C(1:LEN_1D)` and observe which performance events match the beginning of instruction blocks.

What we want to observe is a spike of activity only visible at the beginning of an instruction block.
Any performance event which generates various levels of activity with or without spikes is not well suited, because there might be two different instruction blocks having the same level of activity for a given performance event.
Therefore, we are only interested in the _transitioning_ activity, hence, the spikes.

The final experiment was conducted on the [Intel® Core™ i7-8700 Processor @ 3.20GHz](https://ark.intel.com/content/www/us/en/ark/products/126686/intel-core-i7-8700-processor-12m-cache-up-to-4-60-ghz.html) of the Coffee Lake microarchitecture.

## Results

The result table depicts performance events and indicates which of them can detect instruction blocks.

| Performance event | Can detect instruction block? |
|-------------------|-------------------------------|
|`ARITH:DIVIDER_ACTIVE`|:no_entry_sign:|
|`BACLEARS:ANY`| :heavy_check_mark:|
|`BR_INST_RETIRED:ALL_BRANCHES`|:no_entry_sign:|
|`BR_INST_RETIRED:CONDITIONAL`|:no_entry_sign:|
|`BR_INST_RETIRED:FAR_BRANCH`|:no_entry_sign:|
|`BR_INST_RETIRED:NEAR_CALL`|:heavy_check_mark:|
|`BR_INST_RETIRED:NEAR_RETURN`|:heavy_check_mark:|
|`BR_INST_RETIRED:NEAR_TAKEN`|:no_entry_sign:|
|`BR_INST_RETIRED:NOT_TAKEN`|:no_entry_sign:|
|`BR_MISP_RETIRED:ALL_BRANCHES`|:heavy_check_mark:|
|`BR_MISP_RETIRED:CONDITIONAL`|:no_entry_sign:|
|`BR_MISP_RETIRED:NEAR_CALL`|:heavy_check_mark:|
|`BR_MISP_RETIRED:NEAR_TAKEN`|:heavy_check_mark:|
|`CPU_CLK_THREAD_UNHALTED:ONE_THREAD_ACTIVE`|:no_entry_sign:|
|`CPU_CLK_THREAD_UNHALTED:REF_XCLK`|:no_entry_sign:|
|`CPU_CLK_THREAD_UNHALTED:REF_XCLK_ANY`|:no_entry_sign:|
|`CPU_CLK_THREAD_UNHALTED:RING0_TRANS`|:no_entry_sign:|
|`CPU_CLK_THREAD_UNHALTED:THREAD_P`|:no_entry_sign:|
|`CYCLE_ACTIVITY:CYCLES_L1D_MISS`|:no_entry_sign:|
|`CYCLE_ACTIVITY:CYCLES_L2_MISS`|:no_entry_sign:|
|`CYCLE_ACTIVITY:CYCLES_L3_MISS`|:no_entry_sign:|
|`CYCLE_ACTIVITY:CYCLES_MEM_ANY`|:no_entry_sign:|
|`CYCLE_ACTIVITY:STALLS_L1D_MISS`|:no_entry_sign:|
|`CYCLE_ACTIVITY:STALLS_L2_MISS`|:no_entry_sign:|
|`CYCLE_ACTIVITY:STALLS_L3_MISS`|:no_entry_sign:|
|`CYCLE_ACTIVITY:STALLS_MEM_ANY`|:no_entry_sign:|
|`CYCLE_ACTIVITY:STALLS_TOTAL`|:no_entry_sign:|
|`DSB2MITE_SWITCHES:PENALTY_CYCLES`|:no_entry_sign:|
|`DTLB_LOAD_MISSES:MISS_CAUSES_A_WALK`|:no_entry_sign:|
|`DTLB_LOAD_MISSES:STLB_HIT`|:no_entry_sign:|
|`DTLB_LOAD_MISSES:WALK_ACTIVE`|:no_entry_sign:|
|`DTLB_LOAD_MISSES:WALK_COMPLETED`|:no_entry_sign:|
|`DTLB_LOAD_MISSES:WALK_COMPLETED_1G`|:no_entry_sign:|
|`DTLB_LOAD_MISSES:WALK_COMPLETED_2M_4M`|:no_entry_sign:|
|`DTLB_LOAD_MISSES:WALK_COMPLETED_4K`|:no_entry_sign:|
|`DTLB_LOAD_MISSES:WALK_PENDING`|:no_entry_sign:|
|`DTLB_STORE_MISSES:MISS_CAUSES_A_WALK`|:no_entry_sign:|
|`DTLB_STORE_MISSES:STLB_HIT`|:no_entry_sign:|
|`DTLB_STORE_MISSES:WALK_ACTIVE`|:no_entry_sign:|
|`DTLB_STORE_MISSES:WALK_COMPLETED`|:no_entry_sign:|
|`DTLB_STORE_MISSES:WALK_COMPLETED_1G`|:no_entry_sign:|
|`DTLB_STORE_MISSES:WALK_COMPLETED_2M_4M`|:no_entry_sign:|
|`DTLB_STORE_MISSES:WALK_COMPLETED_4K`|:no_entry_sign:|
|`DTLB_STORE_MISSES:WALK_PENDING`|:no_entry_sign:|
|`EPT:WALK_PENDING`|:no_entry_sign:|
|`EXE_ACTIVITY:1_PORTS_UTIL`|:no_entry_sign:|
|`EXE_ACTIVITY:2_PORTS_UTIL`|:no_entry_sign:|
|`EXE_ACTIVITY:3_PORTS_UTIL`|:no_entry_sign:|
|`EXE_ACTIVITY:4_PORTS_UTIL`|:no_entry_sign:|
|`EXE_ACTIVITY:BOUND_ON_STORES`|:no_entry_sign:|
|`EXE_ACTIVITY:EXE_BOUND_0_PORTS`|:no_entry_sign:|
|`FP_ARITH_INST_RETIRED:128B_PACKED_DOUBLE`|:no_entry_sign:|
|`FP_ARITH_INST_RETIRED:128B_PACKED_SINGLE`|:no_entry_sign:|
|`FP_ARITH_INST_RETIRED:256B_PACKED_DOUBLE`|:no_entry_sign:|
|`FP_ARITH_INST_RETIRED:256B_PACKED_SINGLE`|:no_entry_sign:|
|`FP_ARITH_INST_RETIRED:SCALAR_DOUBLE`|:no_entry_sign:|
|`FP_ARITH_INST_RETIRED:SCALAR_SINGLE`|:no_entry_sign:|
|`FP_ASSIST:ANY`|:no_entry_sign:|
|`FRONTEND_RETIRED:DSB_MISS`|:no_entry_sign:|
|`FRONTEND_RETIRED:ITLB_MISS`|:heavy_check_mark:|
|`FRONTEND_RETIRED:L1I_MISS`|:heavy_check_mark:|
|`FRONTEND_RETIRED:L2_MISS`|:heavy_check_mark:|
|`FRONTEND_RETIRED:STLB_MISS`|:heavy_check_mark:|
|`HLE_RETIRED:ABORTED`|:no_entry_sign:|
|`HLE_RETIRED:ABORTED_EVENTS`|:no_entry_sign:|
|`HLE_RETIRED:ABORTED_MEM`|:no_entry_sign:|
|`HLE_RETIRED:ABORTED_MEMTYPE`|:no_entry_sign:|
|`HLE_RETIRED:ABORTED_UNFRIENDLY`|:no_entry_sign:|
|`HLE_RETIRED:COMMIT`|:no_entry_sign:|
|`HLE_RETIRED:START`|:no_entry_sign:|
|`HW_INTERRUPTS:RECEIVED`|:no_entry_sign:|
|`ICACHE_16B:IFDATA_STALL`|:heavy_check_mark:|
|`ICACHE_64B:IFTAG_HIT`|:no_entry_sign:|
|`ICACHE_64B:IFTAG_MISS`|:heavy_check_mark:|
|`ICACHE_64B:IFTAG_STALL`|:heavy_check_mark:|
|`IDQ:ALL_DSB_CYCLES_4_UOPS`|:no_entry_sign:|
|`IDQ:ALL_DSB_CYCLES_ANY_UOPS`|:no_entry_sign:|
|`IDQ:ALL_MITE_CYCLES_4_UOPS`|:no_entry_sign:|
|`IDQ:ALL_MITE_CYCLES_ANY_UOPS`|:no_entry_sign:|
|`IDQ:DSB_UOPS`|:no_entry_sign:|
|`IDQ:DSB_UOPS_CYCLES`|:no_entry_sign:|
|`IDQ:MITE_UOPS`|:no_entry_sign:|
|`IDQ:MITE_UOPS_CYCLES`|:no_entry_sign:|
|`IDQ:MS_DSB_UOPS_CYCLES`|:no_entry_sign:|
|`IDQ:MS_MITE_UOPS`|:no_entry_sign:|
|`IDQ:MS_SWITCHES`|:no_entry_sign:|
|`IDQ:MS_UOPS`|:no_entry_sign:|
|`IDQ:MS_UOPS_CYCLES`|:no_entry_sign:|
|`IDQ_UOPS_NOT_DELIVERED:CORE`|:no_entry_sign:|
|`IDQ_UOPS_NOT_DELIVERED:CYCLES_0_UOPS_DELIV_CORE`|:heavy_check_mark:|
|`IDQ_UOPS_NOT_DELIVERED:CYCLES_FE_WAS_OK`|:no_entry_sign:|
|`IDQ_UOPS_NOT_DELIVERED:CYCLES_LE_1_UOPS_DELIV_CORE`|:no_entry_sign:|
|`IDQ_UOPS_NOT_DELIVERED:CYCLES_LE_2_UOPS_DELIV_CORE`|:no_entry_sign:|
|`IDQ_UOPS_NOT_DELIVERED:CYCLES_LE_3_UOPS_DELIV_CORE`|:no_entry_sign:|
|`ILD_STALL:LCP`|:heavy_check_mark:|
|`INT_MISC:CLEAR_RESTEER_CYCLES`|:heavy_check_mark:|
|`INT_MISC:RECOVERY_CYCLES`|:heavy_check_mark:|
|`INT_MISC:RECOVERY_CYCLES_ANY`|:heavy_check_mark:|
|`ITLB:ITLB_FLUSH`|:no_entry_sign:|
|`ITLB_MISSES:MISS_CAUSES_A_WALK`|:heavy_check_mark:|
|`ITLB_MISSES:STLB_HIT`|:no_entry_sign:|
|`ITLB_MISSES:WALK_COMPLETED`|:heavy_check_mark:|
|`ITLB_MISSES:WALK_COMPLETED_1G`|:no_entry_sign:|
|`ITLB_MISSES:WALK_COMPLETED_2M_4M`|:no_entry_sign:|
|`ITLB_MISSES:WALK_COMPLETED_4K`|:heavy_check_mark:|
|`ITLB_MISSES:WALK_PENDING`|:heavy_check_mark:|
|`L1D:REPLACEMENT`|:no_entry_sign:|
|`L1D_PEND_MISS:FB_FULL`|:no_entry_sign:|
|`L1D_PEND_MISS:PENDING`|:no_entry_sign:|
|`L1D_PEND_MISS:PENDING_CYCLES`|:no_entry_sign:|
|`L1D_PEND_MISS:PENDING_CYCLES_ANY`|:no_entry_sign:|
|`L2_LINES_IN:ALL`|:no_entry_sign:|
|`L2_LINES_OUT:NON_SILENT`|:no_entry_sign:|
|`L2_LINES_OUT:SILENT`|:no_entry_sign:|
|`L2_LINES_OUT:USELESS_HWPF`|:no_entry_sign:|
|`L2_LINES_OUT:USELESS_HWPREF`|:no_entry_sign:|
|`L2_RQSTS:ALL_CODE_RD`|:heavy_check_mark:|
|`L2_RQSTS:ALL_DEMAND_DATA_RD`|:no_entry_sign:|
|`L2_RQSTS:ALL_DEMAND_MISS`|:no_entry_sign:|
|`L2_RQSTS:ALL_DEMAND_REFERENCES`|:no_entry_sign:|
|`L2_RQSTS:ALL_PF`|:no_entry_sign:|
|`L2_RQSTS:ALL_RFO`|:no_entry_sign:|
|`L2_RQSTS:CODE_RD_HIT`|:no_entry_sign:|
|`L2_RQSTS:CODE_RD_MISS`|:heavy_check_mark:|
|`L2_RQSTS:DEMAND_DATA_RD_HIT`|:no_entry_sign:|
|`L2_RQSTS:DEMAND_DATA_RD_MISS`|:no_entry_sign:|
|`L2_RQSTS:MISS`|:no_entry_sign:|
|`L2_RQSTS:PF_HIT`|:no_entry_sign:|
|`L2_RQSTS:PF_MISS`|:no_entry_sign:|
|`L2_RQSTS:REFERENCES`|:no_entry_sign:|
|`L2_RQSTS:RFO_HIT`|:no_entry_sign:|
|`L2_RQSTS:RFO_MISS`|:no_entry_sign:|
|`L2_TRANS:L2_WB`|:no_entry_sign:|
|`LD_BLOCKS:NO_SR`|:no_entry_sign:|
|`LD_BLOCKS:STORE_FORWARD`|:no_entry_sign:|
|`LD_BLOCKS_PARTIAL:ADDRESS_ALIAS`|:no_entry_sign:|
|`LOAD_HIT_PRE:SW_PF`|:no_entry_sign:|
|`LONGEST_LAT_CACHE:MISS`|:no_entry_sign:|
|`LONGEST_LAT_CACHE:REFERENCE`|:no_entry_sign:|
|`LSD:CYCLES_4_UOPS`|:no_entry_sign:|
|`LSD:CYCLES_ACTIVE`|:no_entry_sign:|
|`LSD:UOPS`|:no_entry_sign:|
|`MACHINE_CLEARS:COUNT`|:no_entry_sign:|
|`MACHINE_CLEARS:MEMORY_ORDERING`|:no_entry_sign:|
|`MACHINE_CLEARS:SMC`|:no_entry_sign:|
|`MEM_INST_RETIRED:ALL_LOADS`|:no_entry_sign:|
|`MEM_INST_RETIRED:ALL_STORES`|:no_entry_sign:|
|`MEM_INST_RETIRED:LOCK_LOADS`|:no_entry_sign:|
|`MEM_INST_RETIRED:SPLIT_LOADS`|:no_entry_sign:|
|`MEM_INST_RETIRED:SPLIT_STORES`|:no_entry_sign:|
|`MEM_INST_RETIRED:STLB_MISS_LOADS`|:no_entry_sign:|
|`MEM_INST_RETIRED:STLB_MISS_STORES`|:no_entry_sign:|
|`MEM_LOAD_L3_HIT_RETIRED:XSNP_HIT`|:no_entry_sign:|
|`MEM_LOAD_L3_HIT_RETIRED:XSNP_HITM`|:no_entry_sign:|
|`MEM_LOAD_L3_HIT_RETIRED:XSNP_MISS`|:no_entry_sign:|
|`MEM_LOAD_L3_HIT_RETIRED:XSNP_NONE`|:no_entry_sign:|
|`MEM_LOAD_MISC_RETIRED:UC`|:no_entry_sign:|
|`MEM_LOAD_RETIRED:FB_HIT`|:no_entry_sign:|
|`MEM_LOAD_RETIRED:L1_HIT`|:no_entry_sign:|
|`MEM_LOAD_RETIRED:L1_MISS`|:no_entry_sign:|
|`MEM_LOAD_RETIRED:L2_HIT`|:no_entry_sign:|
|`MEM_LOAD_RETIRED:L2_MISS`|:no_entry_sign:|
|`MEM_LOAD_RETIRED:L3_HIT`|:no_entry_sign:|
|`MEM_LOAD_RETIRED:L3_MISS`|:no_entry_sign:|
|`OFFCORE_REQUESTS:ALL_DATA_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS:ALL_REQUESTS`|:no_entry_sign:|
|`OFFCORE_REQUESTS:DEMAND_CODE_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS:DEMAND_DATA_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS:DEMAND_RFO`|:no_entry_sign:|
|`OFFCORE_REQUESTS:L3_MISS_DEMAND_DATA_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS_BUFFER:SQ_FULL`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:ALL_DATA_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:CYCLES_WITH_DEMAND_CODE_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:CYCLES_WITH_DEMAND_DATA_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:CYCLES_WITH_DEMAND_RFO`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:CYCLES_WITH_L3_MISS_DEMAND_DATA_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:DEMAND_CODE_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:DEMAND_DATA_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:DEMAND_DATA_RD_GE_6`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:DEMAND_RFO`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:L3_MISS_DEMAND_DATA_RD`|:no_entry_sign:|
|`OFFCORE_REQUESTS_OUTSTANDING:L3_MISS_DEMAND_DATA_RD_GE_6`|:no_entry_sign:|
|`OTHER_ASSISTS:ANY`|:no_entry_sign:|
|`PARTIAL_RAT_STALLS:SCOREBOARD`|:no_entry_sign:|
|`RESOURCE_STALLS:ANY`|:no_entry_sign:|
|`RESOURCE_STALLS:SB`|:no_entry_sign:|
|`ROB_MISC_EVENTS:LBR_INSERTS`|:no_entry_sign:|
|`ROB_MISC_EVENTS:PAUSE_INST`|:no_entry_sign:|
|`RS_EVENTS:EMPTY_CYCLES`|:no_entry_sign:|
|`RS_EVENTS:EMPTY_END`|:no_entry_sign:|
|`RTM_RETIRED:ABORTED`|:no_entry_sign:|
|`RTM_RETIRED:ABORTED_EVENTS`|:no_entry_sign:|
|`RTM_RETIRED:ABORTED_MEM`|:no_entry_sign:|
|`RTM_RETIRED:ABORTED_MEMTYPE`|:no_entry_sign:|
|`RTM_RETIRED:ABORTED_UNFRIENDLY`|:no_entry_sign:|
|`RTM_RETIRED:COMMIT`|:no_entry_sign:|
|`RTM_RETIRED:START`|:no_entry_sign:|
|`SQ_MISC:SPLIT_LOCK`|:no_entry_sign:|
|`SW_PREFETCH_ACCESS:NTA`|:no_entry_sign:|
|`SW_PREFETCH_ACCESS:PREFETCHW`|:no_entry_sign:|
|`SW_PREFETCH_ACCESS:T0`|:no_entry_sign:|
|`SW_PREFETCH_ACCESS:T1_T2`|:no_entry_sign:|
|`TLB_FLUSH:DTLB_THREAD`|:no_entry_sign:|
|`TLB_FLUSH:STLB_ANY`|:no_entry_sign:|
|`TX_EXEC:MISC1`|:no_entry_sign:|
|`TX_EXEC:MISC2`|:no_entry_sign:|
|`TX_EXEC:MISC3`|:no_entry_sign:|
|`TX_EXEC:MISC4`|:no_entry_sign:|
|`TX_EXEC:MISC5`|:no_entry_sign:|
|`TX_MEM:ABORT_CAPACITY`|:no_entry_sign:|
|`TX_MEM:ABORT_CONFLICT`|:no_entry_sign:|
|`TX_MEM:ABORT_HLE_ELISION_BUFFER_FULL`|:no_entry_sign:|
|`TX_MEM:ABORT_HLE_ELISION_BUFFER_MISMATCH`|:no_entry_sign:|
|`TX_MEM:ABORT_HLE_ELISION_BUFFER_NOT_EMPTY`|:no_entry_sign:|
|`TX_MEM:ABORT_HLE_ELISION_BUFFER_UNSUPPORTED_ALIGNMENT`|:no_entry_sign:|
|`TX_MEM:ABORT_HLE_STORE_TO_ELIDED_LOCK`|:no_entry_sign:|
|`UOPS_DISPATCHED_PORT:PORT_0`|:no_entry_sign:|
|`UOPS_DISPATCHED_PORT:PORT_1`|:no_entry_sign:|
|`UOPS_DISPATCHED_PORT:PORT_2`|:no_entry_sign:|
|`UOPS_DISPATCHED_PORT:PORT_3`|:no_entry_sign:|
|`UOPS_DISPATCHED_PORT:PORT_4`|:no_entry_sign:|
|`UOPS_DISPATCHED_PORT:PORT_5`|:no_entry_sign:|
|`UOPS_DISPATCHED_PORT:PORT_6`|:no_entry_sign:|
|`UOPS_DISPATCHED_PORT:PORT_7`|:no_entry_sign:|
|`UOPS_EXECUTED:CORE`|:no_entry_sign:|
|`UOPS_EXECUTED:CORE_CYCLES_GE_1`|:no_entry_sign:|
|`UOPS_EXECUTED:CORE_CYCLES_GE_2`|:no_entry_sign:|
|`UOPS_EXECUTED:CORE_CYCLES_GE_3`|:no_entry_sign:|
|`UOPS_EXECUTED:CORE_CYCLES_GE_4`|:no_entry_sign:|
|`UOPS_EXECUTED:CORE_CYCLES_NONE`|:no_entry_sign:|
|`UOPS_EXECUTED:STALL_CYCLES`|:no_entry_sign:|
|`UOPS_EXECUTED:THREAD`|:no_entry_sign:|
|`UOPS_EXECUTED:THREAD_CYCLES_GE_1`|:no_entry_sign:|
|`UOPS_EXECUTED:THREAD_CYCLES_GE_2`|:no_entry_sign:|
|`UOPS_EXECUTED:THREAD_CYCLES_GE_3`|:no_entry_sign:|
|`UOPS_EXECUTED:THREAD_CYCLES_GE_4`|:no_entry_sign:|
|`UOPS_EXECUTED:X87`|:no_entry_sign:|
|`UOPS_ISSUED:ANY`|:no_entry_sign:|
|`UOPS_ISSUED:SLOW_LEA`|:no_entry_sign:|
|`UOPS_ISSUED:STALL_CYCLES`|:no_entry_sign:|
|`UOPS_ISSUED:VECTOR_WIDTH_MISMATCH`|:no_entry_sign:|
|`UOPS_RETIRED:RETIRE_SLOTS`|:no_entry_sign:|
|`UOPS_RETIRED:STALL_CYCLES`|:no_entry_sign:|
|`UOPS_RETIRED:TOTAL_CYCLES`|:no_entry_sign:|
